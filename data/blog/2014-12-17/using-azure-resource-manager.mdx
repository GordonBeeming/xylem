---
title: 'Using Azure Resource Manager'
date: 2014-12-17
tags: ['Azure', 'Azure Resource Manager', 'Rangers Research', 'PowerShell']
draft: false
summary: 'In the new Azure Portal you create all your resources in Resource Groups, there is also as part of the Azure SDK''s a module called AzureResourceManager by default the module loaded for the Azure SDK is AzureServiceManagement. A blurb from one of the Azure documentation page reads'
---


In the new [Azure Portal](http://portal.azure.com/) you create all your resources in [Resource Groups](http://azure.microsoft.com/en-us/documentation/articles/azure-preview-portal-using-resource-groups/), there is also as part of the [Azure SDK](http://azure.microsoft.com/en-us/downloads/)'s a module called AzureResourceManager  by default the module loaded for the Azure SDK is AzureServiceManagement. A blurb from one of the Azure documentation page reads
 
"*The Azure and Azure Resource Manager modules are not designed to be used in the same Windows PowerShell session. To make it easy to switch between them, we have added a new cmdlet, Switch-AzureMode, to the Azure Profile module.*"
 
### Azure Resource Manager Commands
 
To get a list of all commands that are available for the AzureResourceManager module you can run the command
 
Get-Command -Module AzureResourceManager | Get-Help | Format-Table Name, Synopsis

this will return 

| **Name** | **Synopsis** |
| --- | --- |
| ---- | -------- |
| Add-AzureAccount | Adds the Azure account to Windows PowerShell |
| Add-AzureEnvironment | Creates an Azure environment |
| Clear-AzureProfile | Clears an Azure profile |
| Disable-AzureSqlDatabaseDirectAccess | Disables the option to directly access to an Azure Sql database (without auditing) |
| Disable-AzureSqlDatabaseServerDirectAccess | Disables direct access to all Azure Sql databases that use the audit policy of a Sql databa... |
| Enable-AzureSqlDatabaseDirectAccess | Enables the option to directly access to an Azure Sql database (with auditing) |
| Enable-AzureSqlDatabaseServerDirectAccess | Enables direct access to all Azure Sql databases that use the audit policy of a Sql databas... |
| Get-AzureAccount | Gets Azure accounts that are available to Azure PowerShell. |
| Get-AzureADGroup | Filters active directory groups. |
| Get-AzureADGroupMember | Get a group members. |
| Get-AzureADServicePrincipal | Filters active directory service principals. |
| Get-AzureADUser | Filters active directory users. |
| Get-AzureBatchAccount |  |
| Get-AzureBatchAccountKeys |  |
| Get-AzureDataFactory | Gets information about Data Factory. |
| Get-AzureDataFactoryGateway | Gets information about logical gateways in Data Factory. |
| Get-AzureDataFactoryHub | Gets information about hubs in Data Factory. |
| Get-AzureDataFactoryLinkedService | Gets information about linked services in Data Factory. |
| Get-AzureDataFactoryPipeline | Gets information about pipelines in Data Factory. |
| Get-AzureDataFactoryRun | Gets runs for a data slice of a table in Data Factory. |
| Get-AzureDataFactorySlice | Gets data slices for a table in Data Factory. |
| Get-AzureDataFactoryTable | Gets information about tables in Data Factory. |
| Get-AzureEnvironment | Gets Azure environments |
| Get-AzureLocation | Gets the resource types and the Azure data center locations that support them. |
| Get-AzurePublishSettingsFile | Downloads the publish settings file for an Azure subscription. |
| Get-AzureRedisCache | Gets details about a single cache or all caches in the specified resource group or all cach... |
| Get-AzureRedisCacheKey | Gets the accesskeys for the specified redis cache. |
| Get-AzureResource | Gets Azure resources |
| Get-AzureResourceGroup | Gets Azure resource groups |
| Get-AzureResourceGroupDeployment | Gets the deployments in a resource group. |
| Get-AzureResourceGroupGalleryTemplate | Gets resource group templates in the gallery |
| Get-AzureResourceGroupLog | Gets the deployment log for a resource group |
| Get-AzureRoleAssignment | Filters role assignments. |
| Get-AzureRoleDefinition | Filters role definitions. |
| Get-AzureSqlDatabaseAuditingPolicy | Gets an Azure Sql database's auditing policy. |
| Get-AzureSqlDatabaseServerAuditingPolicy | Gets an Azure Sql server's auditing policy. |
| Get-AzureSubscription | Gets Azure subscriptions in Azure account. |
| Get-AzureTag | Gets predefined Azure tags |
| Import-AzurePublishSettingsFile | Imports a publish settings file that lets you manage your Azure accounts in Windows PowerSh... |
| New-AzureBatchAccount |  |
| New-AzureBatchAccountKey |  |
| New-AzureDataFactory | Creates a data factory. |
| New-AzureDataFactoryEncryptValue | Encrypts sensitive data. |
| New-AzureDataFactoryGateway | Creates a gateway for Data Factory. |
| New-AzureDataFactoryGatewayKey | Creates a gateway key for Data Factory. |
| New-AzureDataFactoryHub | Creates a hub for Data Factory. |
| New-AzureDataFactoryLinkedService | Links a data store or a cloud service to Data Factory. |
| New-AzureDataFactoryPipeline | Creates a pipeline in Data Factory. |
| New-AzureDataFactoryTable | Creates a table in Data Factory. |
| New-AzureRedisCache | Creates a new redis cache. |
| New-AzureRedisCacheKey | Regenerates the access key of a redis cache. |
| New-AzureResource | Creates a new resource in a resource group |
| New-AzureResourceGroup | Creates an Azure resource group and its resources |
| New-AzureResourceGroupDeployment | Add an Azure deployment to a resource group. |
| New-AzureRoleAssignment | Create a role assignment to some principals at a given scope. |
| New-AzureTag | Creates a predefined Azure tag or adds values to an existing tag |
| Remove-AzureAccount | Deletes an Azure account from Windows PowerShell. |
| Remove-AzureBatchAccount |  |
| Remove-AzureDataFactory | Removes a data factory. |
| Remove-AzureDataFactoryGateway | Removes a gateway from Data Factory. |
| Remove-AzureDataFactoryHub | Removes a hub from Data Factory. |
| Remove-AzureDataFactoryLinkedService | Removes a linked service from Data Factory. |
| Remove-AzureDataFactoryPipeline | Removes a pipeline from Data Factory. |
| Remove-AzureDataFactoryTable | Removes a table from Data Factory. |
| Remove-AzureEnvironment | Deletes an Azure environment from Windows PowerShell |
| Remove-AzureRedisCache | Remove redis cache if exists. |
| Remove-AzureResource | Deletes a resource |
| Remove-AzureResourceGroup | Deletes a resource group. |
| Remove-AzureRoleAssignment | Removes a role assignment. |
| Remove-AzureSqlDatabaseAuditing | Disables an Azure Sql database's auditing. |
| Remove-AzureSqlDatabaseServerAuditing | Disables auditing of all the databases that rely on the auditing policy of the given databa... |
| Remove-AzureSubscription | Deletes an Azure subscription from Windows PowerShell. |
| Remove-AzureTag | Deletes predefined Azure tags or values |
| Resume-AzureDataFactoryPipeline | Resumes a suspended pipeline in Data Factory. |
| Save-AzureDataFactoryLog | Downloads log files from HDInsight processing. |
| Save-AzureResourceGroupGalleryTemplate | Saves a gallery template to a JSON file |
| Select-AzureSubscription | Changes the current and default Azure subscriptions |
| Set-AzureBatchAccount |  |
| Set-AzureDataFactoryGateway | Sets the description for a gateway in Data Factory. |
| Set-AzureDataFactoryPipelineActivePeriod | Configures the active period for data slices. |
| Set-AzureDataFactorySliceStatus | Sets the status of slices for a table in Data Factory. |
| Set-AzureEnvironment | Changes the properties of an Azure environment |
| Set-AzureRedisCache | Set redis cache updatable parameters. |
| Set-AzureResource | Changes the properties of an Azure resource. |
| Set-AzureResourceGroup | Changes the properties of a resource group |
| Set-AzureSqlDatabaseAuditingPolicy | Sets an Azure Sql database's auditing policy. |
| Set-AzureSqlDatabaseServerAuditingPolicy | Sets an Azure Sql database server's auditing policy. |
| Set-AzureSubscription | Creates or changes an Azure subscription |
| Stop-AzureResourceGroupDeployment | Cancels a resource group deployment |
| Suspend-AzureDataFactoryPipeline | Suspends a pipeline in Data Factory. |
| Switch-AzureMode | Switches between the Azure and Azure Resource Manager modules |
| Test-AzureResourceGroupTemplate | Detects errors in a resource group template or template parameters |
| Use-AzureSqlDatabaseServerAuditingPolicy | Marks an Azure Sql database as using its server's auditing policy. |

## Step 0

As a step 0 lets open up everything we need. 

### Azure SDK 

So to get started you need to install the Azure SDK which you can get from the [SDK downloads page](http://azure.microsoft.com/en-us/downloads/). I am using [Azure SDK 2.5](http://azure.microsoft.com/blog/2014/11/12/announcing-azure-sdk-2-5-for-net-and-visual-studio-2015-preview/) version for this post.

### PowerShell ISE

Open the PowerShell ISE using Win + R and then %WINDIR%\system32\WindowsPowerShell\v1.0\powershell\_ise.exe. You can also use the standard PowerShell window if you want.

### Azure Management Portal

Open and sign in to the [Azure Management Portal](https://manage.windowsazure.com/) ([https://manage.windowsazure.com/](https://manage.windowsazure.com/))

### Azure Portal

Open and sign in to the [Azure Portal](http://portal.azure.com/) ([http://portal.azure.com/](http://portal.azure.com/ "http://portal.azure.com/"))

## Step 1

Let's start by getting the Azure Management Portal pieces out the way. In the Azure Management Portal we will just be creating a new AAD user that we can use to automatically login through PowerShell. If you want to use a MSA just leave the credentials bit off in Step 3 and you will receive a prompt for credentials at which time you can use MSA or AAD credentials and you can now move to step 2. If you want to create the new user follow my other post [Creating a new Azure Active Directory User](https://gordonbeeming.com/blog/post/creating-a-new-azure-active-directory-user) to create a user for this demo.

## Step 2

In the PowerShell ISE we will kick off by switching the Azure SDK to use the resource manager module. 

Switch-AzureMode -Name AzureResourceManager

## Step 3

After we have switched to the AzureResourceManager module we are able to use the commands that are part of it. Let's start off by adding our Azure Account we just created using the snippet below (I keep my username and password in txt files and reference from multiple sample scripts for ease of use but you can place them straight in the script if you wanted

[string]$currentUsername = Get-Content "Z:\_PowerShell\Azure\currentUser.txt"[string]$currentPassword = Get-Content "Z:\_PowerShell\Azure\currentPass.txt"$secpasswd = ConvertTo-SecureString $currentPassword -AsPlainText -Force$mycreds = New-Object System.Management.Automation.PSCredential ($currentUsername, $secpasswd)Add-AzureAccount -credential $mycreds

This would then return the account added

<Figure key="/images/9eef83312a5349b78143bf920e5a698b.png" src="/images/9eef83312a5349b78143bf920e5a698b.png" alt="PowerShell output after adding Azure account" width="0" height="0" caption="PowerShell output showing the successfully added Azure account details." />

At this point if you ran Get-AzureAccount it will show you this account and any others you have previously added.

<Figure key="/images/beccbfae32194e6daf525cd62f8df172.png" src="/images/beccbfae32194e6daf525cd62f8df172.png" alt="PowerShell output of Get-AzureAccount command" width="0" height="0" caption="PowerShell output of the Get-AzureAccount command, listing available Azure accounts." />

## Step 4

Next we'll explore some meta data for Step 5. 

### 

### Getting a Resource Group Template

We can run the command 

Get-AzureResourceGroupGalleryTemplate

and it will return a list of all the current resources group templates that we can create. For the list at the time of writing this post you can refer to one of my [GitHub](http://github.com) Gists at [https://gordonbeeming.com/blog/gist/ea0884f5ba00c62a83e4](https://gordonbeeming.com/blog/gist/ea0884f5ba00c62a83e4 "https://gordonbeeming.com/blog/gist/ea0884f5ba00c62a83e4"). We are going to be using one of the templates found around line 2220 which is the website and sql database.

<Figure key="/images/e7aaeda582f14a648853eb495d52340a.png" src="/images/e7aaeda582f14a648853eb495d52340a.png" alt="GitHub Gist showing Azure Resource Group Gallery Templates" width="0" height="0" caption="A GitHub Gist displaying a list of Azure Resource Group Gallery Templates, with the website and SQL database template highlighted." /> 

### Get a list of Azure Resource Locations

When creating Azure Resources you need to specify were those resources are located geographically. Now you could guess or [Bing](http://www.bing.com/) what the locations are or you could use the handy command

Get-AzureLocation

which will return you a list of every location that every resource is available in. This list as with the one above can be found as one of my GitHub Gists at [https://gordonbeeming.com/blog/gist/87aad8bfbbbcd7421b83](https://gordonbeeming.com/blog/gist/87aad8bfbbbcd7421b83 "https://gordonbeeming.com/blog/gist/87aad8bfbbbcd7421b83"). From the long list of locations we are just going to use West Europe for all our resources

## Step 5

At this point we have all the info we need to create our resources using the resource manager in powershell so we'll use the snippet

$ResourceManagerTest = "ResourceManagerTest"$AzureDataCenterLocation = "West Europe"$administratorLoginPassword = ConvertTo-SecureString "$($ResourceManagerTest)DbP@ssw0rd" -AsPlainText -ForceNew-AzureResourceGroup -Name "$($ResourceManagerTest)" `                        -Location "$AzureDataCenterLocation" `                        -GalleryTemplateIdentity Microsoft.WebSiteSQLDatabase.0.2.2-preview `                        -siteName "$($ResourceManagerTest)Site" `                        -hostingPlanName "$($ResourceManagerTest)Plan" `                        -siteLocation "$AzureDataCenterLocation" `                        -serverName "$($ResourceManagerTest.ToLowerInvariant())dbserver" `                        -serverLocation "$AzureDataCenterLocation" `                        -administratorLogin "$($ResourceManagerTest)DbLogin" `                        -administratorLoginPassword $administratorLoginPassword `                        -databaseName "$($ResourceManagerTest)DbName" `                        -Verbose

This will then go off and create our website and database along with an Application Insights resource that we can use for our website when we deploy it. When the command finishes you should see an output similar to the one below which because we specified the -verbose flag tells us the status of each resource created

<Figure key="/images/238967f8d0f6433c89bcc0ee5cf7c9db.png" src="/images/238967f8d0f6433c89bcc0ee5cf7c9db.png" alt="PowerShell verbose output after creating Azure Resource Group" width="0" height="0" caption="PowerShell verbose output detailing the status of each resource created within the new Azure Resource Group." />

At this point we really are finished with what the subject of the blog post is but we'll continue on to explore what we have just created, how we would have had to create it using the Azure Portal and how we can remove the resource group using PowerShell.

## Step 6

Open the Azure Portal. The first thing you should notice is that you already have a notification and when you open that it says that a deployment has succeeded.

<Figure key="/images/db8a8b544a424ef4a4b15b78ac51d0c3.png" src="/images/db8a8b544a424ef4a4b15b78ac51d0c3.png" alt="Azure Portal notification of successful deployment" width="0" height="0" caption="Azure Portal notification indicating the successful deployment of the new Resource Group." />

Clicking on the success notification will open that resource group

<Figure key="/images/fa36e6f9233d419aba6011acbe816c01.png" src="/images/fa36e6f9233d419aba6011acbe816c01.png" alt="Azure Portal view of the newly created Resource Group and its resources" width="0" height="0" caption="Azure Portal displaying the newly created Resource Group and the resources within it (website, SQL database, App Insights)." />

From here you can use the resources 100% as if you created them in the portal.

## Step 7

Before we see how we would have had to create those resources manually let's remove the resource group from our subscription. To do this we run the simple command below keeping in mind that the $ResourceManagerTest variable should still be set from the previous command in step 5 

Remove-AzureResourceGroup -Name $ResourceManagerTest -Force -Verbose

this will then proceed to remove the resource group, again because of the -verbose flag we don't get as much info but rather just that it's deleting the resource group and then comes back when it's done.

<Figure key="/images/e11a38eaa7214a56b533958227775021.png" src="/images/e11a38eaa7214a56b533958227775021.png" alt="PowerShell output after removing Azure Resource Group" width="0" height="0" caption="PowerShell output confirming the deletion of the Azure Resource Group." />

## Step 8

The last thing that I'll show on this post is how we would of have to do this manually (or at least where to find template). Back in the Azure Portal click new in the bottom left corner and then click on Everything

<Figure key="/images/7e610f68dae14218b39bdf9c6d4b06e1.png" src="/images/7e610f68dae14218b39bdf9c6d4b06e1.png" alt="Azure Portal - New resource selection with Everything highlighted" width="0" height="0" caption="Azure Portal: Clicking 'New' and then 'Everything' to browse available resources." />

Next click on the Web category/section and then you'll see the Website + SQL option which is what we created

<Figure key="/images/be8e1b50a5b943fa818b9dcea256bcd5.png" src="/images/be8e1b50a5b943fa818b9dcea256bcd5.png" alt="Azure Portal - Web category with Website + SQL option highlighted" width="0" height="0" caption="Azure Portal: Selecting the 'Web' category and then the 'Website + SQL' template." />

clicking on that option will give you a little info about the template and from here you'd just click on create

<Figure key="/images/fe417656ddaa4f16baadc41889fe29d8.png" src="/images/fe417656ddaa4f16baadc41889fe29d8.png" alt="Azure Portal - Website + SQL template information and Create button" width="0" height="0" caption="Azure Portal: Information about the 'Website + SQL' template with the 'Create' button visible." />

From here you will configure the Resource Group Name, all the settings for your Website resource and SQL resource and then click create.

<Figure key="/images/0bb2ebe0e61746a7bb9abd332838e476.png" src="/images/0bb2ebe0e61746a7bb9abd332838e476.png" alt="Azure Portal - Configuration blade for Website + SQL template" width="0" height="0" caption="Azure Portal: Configuration blade for the 'Website + SQL' template, requiring Resource Group name, website settings, and SQL settings." />

When that process completes you will be in the sample place as that small PowerShell script gets you too 🙂

## Thoughts and comments

If you have any thoughts or comments about any of the pieces of this post please do share below.

